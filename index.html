<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>NachoZorra Generator ðŸ¦Š</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Felt Tip Roman -->
    <link href="https://fonts.cdnfonts.com/css/felt-tip-roman" rel="stylesheet">

    <style>
        :root {
            --font-normal: 'Felt Tip Roman', cursive;
            --font-brat: 'Helvetica Neue', Arial, sans-serif;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: #f3f4f6;
            height: 100vh;
            overflow: hidden;
            font-family: var(--font-normal);
        }

        .preview-container {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            height: calc(100vh - 150px);
        }

        #previewCanvas {
            box-shadow: 0 10px 25px -3px rgba(0,0,0,0.25);
            border-radius: 1rem;
            max-width: 90vh;
            max-height: 90vw;
            aspect-ratio: 1 / 1;
            width: min(90vw, 90vh);
        }

        .control-panel {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid #ddd;
            padding: 1rem;
            z-index: 10;
        }

        /* Toggle estilo iPhone */
        .toggle {
            width: 60px;
            height: 30px;
            background: #ccc;
            border-radius: 30px;
            padding: 3px;
            cursor: pointer;
            position: relative;
            transition: background 0.3s;
        }

        .toggle-circle {
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 3px;
            left: 3px;
            transition: transform 0.3s;
        }

        .toggle.active {
            background: #4ade80;
        }

        .toggle.active .toggle-circle {
            transform: translateX(30px);
        }
    </style>
</head>
<body>

    <div class="preview-container">
        <canvas id="previewCanvas" width="1080" height="1080"></canvas>
    </div>

    <!-- PANEL DE CONTROL -->
    <div class="control-panel flex flex-col md:flex-row items-center justify-center space-y-3 md:space-y-0 md:space-x-4">

        <div class="flex items-center space-x-3">
            <span class="font-bold text-gray-700">Modo:</span>
            <div id="modeToggle" class="toggle">
                <div class="toggle-circle"></div>
            </div>
            <span id="modeLabel" class="font-semibold text-gray-700">Normal</span>
        </div>

        <div class="w-full md:w-2/5">
            <input type="text" id="textInput" placeholder="Escribe tu frase aquÃ­..."
                   value="NachoZorra Generator ðŸ¦Š"
                   class="w-full p-3 text-lg border-2 border-gray-300 rounded-xl focus:border-blue-600 
                          text-gray-700 shadow-inner placeholder-gray-400 focus:outline-none">
        </div>

        <div class="flex items-center space-x-3">
            <label class="text-sm font-semibold text-gray-700">Fondo:</label>
            <input type="color" id="bgColorInput" value="#ffffff" class="w-10 h-10 rounded-full shadow">
        </div>

        <button id="downloadBtn"
                class="px-6 py-3 bg-indigo-600 text-white font-bold rounded-xl shadow-lg
                       hover:bg-indigo-700 active:bg-indigo-800 transition duration-150 transform hover:scale-105">
            Descargar PNG
        </button>

    </div>

    <script>
        const canvas = document.getElementById("previewCanvas");
        const ctx = canvas.getContext("2d");

        const textInput = document.getElementById("textInput");
        const bgColorInput = document.getElementById("bgColorInput");
        const downloadBtn = document.getElementById("downloadBtn");

        const modeToggle = document.getElementById("modeToggle");
        const modeLabel = document.getElementById("modeLabel");

        let mode = "normal"; // normal | brat

        const CANVAS_SIZE = 1080;
        const PADDING = 100;

        const MAX_FONT_SIZE = 180;
        const MIN_FONT_SIZE = 50;

        const FELT_FONT = "'Felt Tip Roman', cursive";
        const BRAT_FONT = "'Helvetica Neue', Arial, sans-serif";

        /* UTILIDADES */

        function hexToRgb(hex) {
            const bigint = parseInt(hex.slice(1), 16);
            return [(bigint>>16)&255, (bigint>>8)&255, bigint&255];
        }

        function isDarkColor(hex) {
            const [r,g,b] = hexToRgb(hex);
            const luminance = (0.2126*r + 0.7152*g + 0.0722*b)/255;
            return luminance < 0.55;
        }

        function wrapText(text, maxWidth, fontSize) {
            ctx.font = `${fontSize}px ${mode === "brat" ? BRAT_FONT : FELT_FONT}`;

            const words = text.split(" ");
            let line = "";
            const lines = [];

            for (let w of words) {
                const test = line + w + " ";
                if (ctx.measureText(test).width > maxWidth && line !== "") {
                    lines.push(line.trim());
                    line = w + " ";
                } else {
                    line = test;
                }
            }
            if (line.trim()) lines.push(line.trim());

            return lines;
        }



        function drawJustified(line, x, y, maxWidth, fontSize, textColor) {
            ctx.fillStyle = textColor;   // â† COLOR CORRECTO

            const words = line.split(" ");
            if (words.length === 1) {
                ctx.fillText(line, x, y);
                return;
            }

            const textWidth = ctx.measureText(line).width;
            const spaceExtra = (maxWidth - textWidth) / (words.length - 1);

            let currentX = x - maxWidth / 2;

            words.forEach((word, i) => {
                ctx.fillText(word, currentX, y);
                currentX += ctx.measureText(word).width + (i < words.length - 1 ? spaceExtra : 0);
            });
        }


        /* MARCA DE AGUA NORMAL */
        function watermarkNormal() {
            ctx.save();
            ctx.globalAlpha = 0.09;
            ctx.fillStyle = "#000";
            ctx.font = `220px ${FELT_FONT}`;
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";

            ctx.translate(CANVAS_SIZE/2, CANVAS_SIZE/2);
            ctx.rotate(-Math.PI / 6);
            ctx.fillText("@nachozorra", 0, 0);

            ctx.restore();
        }

        /* MARCA DE AGUA BRAT */
        function watermarkBrat() {
            ctx.save();
            ctx.globalAlpha = 0.035;
            ctx.fillStyle = "#000";
            ctx.font = `320px ${BRAT_FONT}`;
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";

            ctx.translate(CANVAS_SIZE/2, CANVAS_SIZE/2);
            ctx.rotate(-Math.PI / 6);
            ctx.fillText("@nachozorra", 0, 0);

            ctx.restore();
        }

        /* DIBUJO PRINCIPAL */
        function draw() {
            const text = textInput.value.trim();
            const bgColor = bgColorInput.value;

            ctx.fillStyle = bgColor;
            ctx.fillRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);

            /* Marca de agua segÃºn modo */
            if (mode === "normal") watermarkNormal();
            else watermarkBrat();

            if (!text) return;

            const fontBase = mode === "brat" ? BRAT_FONT : FELT_FONT;

            /* CÃ¡lculo de densidad */
            const length = text.length;
            const density = Math.log(1 + length);

            /* TamaÃ±o dependiente del modo */
            let fontSize = MAX_FONT_SIZE / (1 + density * (mode === "brat" ? 0.55 : 0.25));
            fontSize = Math.max(MIN_FONT_SIZE, fontSize);

            /* Blur progresivo en modo brat */
            if (mode === "brat") {
                ctx.filter = `blur(${density * 0.8}px)`;
            } else {
                ctx.filter = "none";
            }

            ctx.font = `${fontSize}px ${fontBase}`;
            ctx.textBaseline = "top";
            ctx.textAlign = "center";

            const textColor = isDarkColor(bgColor) ? "#ffffff" : "#111";

            const maxWidth = CANVAS_SIZE - PADDING * 2;
            const lines = wrapText(text, maxWidth, fontSize);
            const lineHeight = fontSize * 1.2;

            const totalHeight = lines.length * lineHeight;
            let y = (CANVAS_SIZE - totalHeight) / 2;

            lines.forEach(line => {
                if (mode === "brat") {
                    drawJustified(line, CANVAS_SIZE/2, y, maxWidth, fontSize, textColor);
                } else {
                    /* Outline */
                    ctx.lineWidth = Math.max(4, fontSize*0.06);
                    ctx.strokeStyle = "rgba(0,0,0,0.35)";
                    ctx.strokeText(line, CANVAS_SIZE/2, y);
                    ctx.fillStyle = textColor;
                    ctx.fillText(line, CANVAS_SIZE/2, y);
                }
                y += lineHeight;
            });

            ctx.filter = "none";
        }

        /* DESCARGAR */
        function downloadImage() {
            draw();
            const url = canvas.toDataURL("image/png");
            const link = document.createElement("a");
            link.href = url;
            link.download = `nachozorra_${Date.now()}.png`;
            link.click();
        }

        /* SWITCH */
        modeToggle.addEventListener("click", () => {
            modeToggle.classList.toggle("active");

            mode = modeToggle.classList.contains("active") ? "brat" : "normal";
            modeLabel.textContent = mode === "brat" ? "Brat" : "Normal";

            draw();
        });

        /* EVENTOS */
        textInput.addEventListener("input", draw);
        bgColorInput.addEventListener("input", draw);
        downloadBtn.addEventListener("click", downloadImage);

        /* INIT */
        window.onload = async () => {
            if (document.fonts && document.fonts.load) {
                await document.fonts.load("60px " + FELT_FONT);
                await document.fonts.load("60px " + BRAT_FONT);
            }
            draw();
        };
    </script>

</body>
</html>
