<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NachoZorra Generator ðŸ¦Š</title>

  <link href="https://fonts.cdnfonts.com/css/felt-tip-roman" rel="stylesheet">
  <link href="https://fonts.cdnfonts.com/css/arial-narrow" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root { --controls-h: 110px; }

    body {
      background: #111;
      margin: 0;
      color: #fff;
      font-family: 'Felt Tip Roman', cursive;
      overflow: hidden;
    }

    #stage {
      height: calc(100vh - var(--controls-h));
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #previewCanvas {
      width: min(90vw, 90vh);
      height: min(90vw, 90vh);
      box-shadow: 0 8px 30px rgba(0,0,0,0.35);
      border-radius: 25px;
      background: #fff;
    }

    .control-panel {
      position: fixed;
      bottom: 0;
      width: 100%;
      height: var(--controls-h);
      background: rgba(0,0,0,0.88);
      backdrop-filter: blur(10px);
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 6px;
      z-index: 20;
      padding-bottom: 6px;
    }

    .switch { position: relative; width: 55px; height: 28px; }
    .switch input { display: none; }
    .slider {
      position: absolute;
      inset: 0;
      cursor: pointer;
      background: #555;
      border-radius: 34px;
      transition: .3s;
    }
    .slider:before {
      content: "";
      position: absolute;
      width: 22px;
      height: 22px;
      left: 3px;
      bottom: 3px;
      background: white;
      border-radius: 50%;
      transition: .3s;
    }
    input:checked + .slider { background: #22c55e; }
    input:checked + .slider:before { transform: translateX(26px); }

    #bgColor {
      width: 34px; height: 34px;
      border-radius: 999px; border: none;
      overflow: hidden; padding: 0;
    }
    #bgColor::-webkit-color-swatch,
    #bgColor::-moz-color-swatch {
      border: none;
      border-radius: 999px;
    }
  </style>
</head>
<body>

  <main id="stage">
    <canvas id="previewCanvas" width="1080" height="1080"></canvas>
  </main>

  <div class="control-panel">
    <div class="flex items-center justify-center gap-3 text-sm">
      <span>Modo:</span>
      <label class="switch">
        <input type="checkbox" id="modeToggle">
        <span class="slider"></span>
      </label>
      <span id="modeLabel">Normal</span>
    </div>

    <div class="flex items-center justify-center gap-3 w-full px-3">
      <input id="textInput" type="text" placeholder="Escribe tu frase..."
             class="flex-1 p-2 rounded-lg text-black text-center font-bold text-lg outline-none">

      <div class="flex items-center gap-1 text-sm">
        <span>Fondo:</span>
        <input type="color" id="bgColor" value="#ffffff">
      </div>

      <button id="downloadBtn"
              class="px-5 py-2 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 active:bg-indigo-800">
        Descargar PNG
      </button>
    </div>
  </div>

<script>
const canvas = document.getElementById("previewCanvas");
const ctx = canvas.getContext("2d");
const input = document.getElementById("textInput");
const bgColorInput = document.getElementById("bgColor");
const toggle = document.getElementById("modeToggle");
const modeLabel = document.getElementById("modeLabel");

const CANVAS_SIZE = 1080;
const PADDING = 80;

if (document.fonts && document.fonts.ready) {
  document.fonts.ready.then(draw);
} else window.onload = draw;

input.addEventListener("input", draw);
bgColorInput.addEventListener("input", draw);
toggle.addEventListener("change", () => {
  modeLabel.textContent = toggle.checked ? "Brat" : "Normal";
  draw();
});
document.getElementById("downloadBtn").addEventListener("click", downloadPNG);

function draw() {
  const text = input.value.trim();
  const bg = bgColorInput.value;

  ctx.fillStyle = bg;
  ctx.fillRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);

  drawWatermark();

  if (!text) {
    drawPlaceholder();
    return;
  }

  if (toggle.checked) drawBrat(text, bg);
  else drawNormal(text, bg);
}

function drawNormal(text, bg) {
  ctx.save();
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  ctx.fillStyle = getContrastColor(bg);

  const maxFont = 80, minFont = 36;
  let fontSize = maxFont;
  const maxWidth = CANVAS_SIZE - 2 * PADDING;

  while (fontSize > minFont) {
    ctx.font = fontSize + "px 'Felt Tip Roman'";
    const lines = wrapText(text, maxWidth, ctx);
    const th = lines.length * fontSize * 1.2;
    if (th <= CANVAS_SIZE - 2 * PADDING) break;
    fontSize -= 4;
  }

  ctx.font = fontSize + "px 'Felt Tip Roman'";
  const lines = wrapText(text, maxWidth, ctx);
  const totalHeight = lines.length * fontSize * 1.2;
  let y = CANVAS_SIZE / 2 - totalHeight / 2 + fontSize * 0.1;

  for (const line of lines) {
    ctx.fillText(line, CANVAS_SIZE / 2, y);
    y += fontSize * 1.2;
  }

  ctx.restore();
}

function drawBrat(text, bg) {
  ctx.save();
  const textColor = getContrastColor(bg);

  const innerWidth = CANVAS_SIZE - 2 * PADDING;
  const maxHeight = CANVAS_SIZE * 0.75;
  const maxFont = 200, minFont = 40;

  let low = minFont, high = maxFont, bestFont = minFont, bestLines = [];

  while (low <= high) {
    const mid = (low + high) >> 1;
    ctx.font = mid + "px 'Arial Narrow'";
    const candidate = wrapWordsToLines(text, innerWidth, ctx);
    const th = candidate.length * mid * 1.1;

    if (th <= maxHeight) {
      bestFont = mid;
      bestLines = candidate;
      low = mid + 4;
    } else high = mid - 4;
  }

  ctx.font = bestFont + "px 'Arial Narrow'";
  ctx.textBaseline = "top";
  ctx.fillStyle = textColor;
  const lh = bestFont * 1.1;

  const blockH = bestLines.length * lh;
  let y = (CANVAS_SIZE - blockH) / 2;

  bestLines.forEach((words, idx) => {
    const last = idx === bestLines.length - 1;
    drawJustifiedLine(words, PADDING, y, innerWidth, last, ctx);
    y += lh;
  });

  ctx.restore();
}

function wrapText(text, maxWidth, ctx) {
  const words = text.split(/\s+/);
  const lines = [];
  let line = "";

  for (const w of words) {
    const test = line ? line + " " + w : w;
    if (ctx.measureText(test).width > maxWidth && line) {
      lines.push(line);
      line = w;
    } else line = test;
  }
  if (line) lines.push(line);
  return lines;
}

function wrapWordsToLines(text, maxWidth, ctx) {
  const words = text.split(/\s+/).filter(Boolean);
  const lines = [];
  let cur = [];

  words.forEach(w => {
    const test = [...cur, w].join(" ");
    if (ctx.measureText(test).width > maxWidth && cur.length > 0) {
      lines.push(cur);
      cur = [w];
    } else cur.push(w);
  });

  if (cur.length) lines.push(cur);
  return lines;
}

function drawJustifiedLine(words, x, y, width, last, ctx) {
  const baseSpace = ctx.measureText(" ").width;

  if (last || words.length === 1) {
    let cx = x;
    ctx.filter = "blur(3px)";
    words.forEach(w => {
      ctx.fillText(w, cx, y);
      cx += ctx.measureText(w).width + baseSpace;
    });
    ctx.filter = "none";
    return;
  }

  const wordsW = words.reduce((a, w) => a + ctx.measureText(w).width, 0);
  const spaces = words.length - 1;
  const extra = width - wordsW;
  const spaceSize = extra / spaces;

  let cx = x;
  ctx.filter = "blur(3px)";
  words.forEach((w, i) => {
    ctx.fillText(w, cx, y);
    if (i < words.length - 1)
      cx += ctx.measureText(w).width + spaceSize;
  });
  ctx.filter = "none";
}

function drawWatermark() {
  ctx.save();
  ctx.globalAlpha = 0.08;
  ctx.fillStyle = "#000";
  ctx.font = "260px 'Arial Narrow'";
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  ctx.translate(CANVAS_SIZE/2, CANVAS_SIZE/2);
  ctx.rotate(-0.6);
  ctx.filter = "blur(3px)";
  ctx.fillText("@nachozorra", 0, 0);
  ctx.restore();
}

function drawPlaceholder() {
  ctx.save();
  ctx.fillStyle = "rgba(0,0,0,0.35)";
  ctx.font = "42px 'Felt Tip Roman'";
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  ctx.fillText("Escribe algo abajo para generar ðŸ¦Š", CANVAS_SIZE/2, CANVAS_SIZE/2);
  ctx.restore();
}

function getContrastColor(hex) {
  hex = hex.replace("#","");
  const r = parseInt(hex.slice(0,2),16);
  const g = parseInt(hex.slice(2,4),16);
  const b = parseInt(hex.slice(4,6),16);
  return ((r*299 + g*587 + b*114)/1000) > 150 ? "#000" : "#fff";
}

function downloadPNG() {
  const a = document.createElement("a");
  a.download = "nachozorra_" + Date.now() + ".png";
  a.href = canvas.toDataURL();
  a.click();
}
</script>

</body>
</html>
