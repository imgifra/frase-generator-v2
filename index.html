<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>NachoZorra Generator ðŸ¦Š</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Felt Tip Roman -->
    <link href="https://fonts.cdnfonts.com/css/felt-tip-roman" rel="stylesheet">

    <style>
        :root {
            --font-normal: 'Felt Tip Roman', cursive;
            --font-brat: 'Helvetica Neue', Arial, sans-serif;
        }

        body {
            margin: 0;
            background: #f3f4f6;
            height: 100vh;
            overflow: hidden;
        }

        .preview-container {
            width: 100%;
            height: calc(100vh - 150px);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #previewCanvas {
            width: min(90vw, 90vh);
            aspect-ratio: 1/1;
            box-shadow: 0 10px 25px -3px rgba(0,0,0,0.25);
            border-radius: 1rem;
        }

        .control-panel {
            position: fixed;
            bottom: 0;
            width: 100%;
            padding: 1rem;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid #ddd;
        }

        .toggle {
            width: 60px;
            height: 30px;
            background: #ccc;
            border-radius: 30px;
            padding: 3px;
            cursor: pointer;
            position: relative;
            transition: 0.3s;
        }

        .toggle-circle {
            width: 24px;
            height: 24px;
            background: #fff;
            border-radius: 50%;
            position: absolute;
            top: 3px;
            left: 3px;
            transition: transform 0.3s;
        }

        .toggle.active {
            background: #4ade80;
        }

        .toggle.active .toggle-circle {
            transform: translateX(30px);
        }
    </style>
</head>

<body>

    <div class="preview-container">
        <canvas id="previewCanvas" width="1080" height="1080"></canvas>
    </div>

    <div class="control-panel flex flex-col md:flex-row items-center justify-center space-y-3 md:space-y-0 md:space-x-4">

        <div class="flex items-center space-x-3">
            <span class="font-bold">Modo:</span>
            <div id="modeToggle" class="toggle"><div class="toggle-circle"></div></div>
            <span id="modeLabel" class="font-semibold">Normal</span>
        </div>

        <input id="textInput" type="text" placeholder="Escribe tu frase..."
            class="w-full md:w-2/4 p-3 border-2 rounded-xl">

        <div class="flex items-center space-x-3">
            <span class="font-semibold">Fondo:</span>
            <input id="bgColorInput" type="color" value="#ffffff" class="w-10 h-10 rounded-full shadow">
        </div>

        <button id="downloadBtn"
            class="px-6 py-3 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700">
            Descargar PNG
        </button>

    </div>

    <script>
        const canvas = document.getElementById("previewCanvas");
        const ctx = canvas.getContext("2d");

        const textInput = document.getElementById("textInput");
        const bgColorInput = document.getElementById("bgColorInput");
        const downloadBtn = document.getElementById("downloadBtn");

        const modeToggle = document.getElementById("modeToggle");
        const modeLabel = document.getElementById("modeLabel");

        let mode = "normal";

        const CANVAS_SIZE = 1080;
        const PADDING = 100;
        const MAX_FONT_SIZE = 180;
        const MIN_FONT_SIZE = 48;

        function hexToRgb(hex) {
            const n = parseInt(hex.slice(1), 16);
            return [(n>>16)&255, (n>>8)&255, n&255];
        }

        function isDarkColor(hex) {
            const [r,g,b] = hexToRgb(hex);
            const L = (0.2126*r + 0.7152*g + 0.0722*b)/255;
            return L < 0.55;
        }

        /* WRAP SIN BLUR */
        function wrapText(text, maxWidth, fontSize, font) {
            ctx.filter = "none";
            ctx.font = `${fontSize}px ${font}`;

            const words = text.split(" ");
            let line = "";
            const lines = [];

            for (let w of words) {
                const t = line + w + " ";
                if (ctx.measureText(t).width > maxWidth && line !== "") {
                    lines.push(line.trim());
                    line = w + " ";
                } else {
                    line = t;
                }
            }
            if (line.trim()) lines.push(line.trim());

            return lines;
        }

        /* JUSTIFY SIN BLUR PARA CALCULAR ESPACIOS */
        function drawJustified(line, x, y, maxWidth, fontSize, font, textColor) {

            ctx.save();
            ctx.filter = "none";
            ctx.font = `${fontSize}px ${font}`;
            ctx.fillStyle = textColor;

            const words = line.split(" ");

            if (words.length === 1) {
                ctx.restore();
                ctx.fillText(line, x, y);
                return;
            }

            const pureWidth = ctx.measureText(line).width;
            const extra = (maxWidth - pureWidth) / (words.length - 1);

            let ox = x - maxWidth / 2;

            ctx.restore(); // Vuelve al blur actual pero mantiene coordenadas

            ctx.fillStyle = textColor;
            ctx.font = `${fontSize}px ${font}`;

            words.forEach((w,i)=>{
                ctx.fillText(w, ox, y);
                ox += ctx.measureText(w).width + extra;
            });
        }

        /* WATERMARK NORMAL */
        function watermarkNormal() {
            ctx.save();
            ctx.globalAlpha = 0.09;
            ctx.fillStyle = "#000";
            ctx.font = `220px var(--font-normal)`;
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.translate(CANVAS_SIZE/2, CANVAS_SIZE/2);
            ctx.rotate(-Math.PI/6);
            ctx.fillText("@nachozorra", 0, 0);
            ctx.restore();
        }

        /* WATERMARK BRAT */
        function watermarkBrat() {
            ctx.save();
            ctx.globalAlpha = 0.035;
            ctx.fillStyle = "#000";
            ctx.font = `320px var(--font-brat)`;
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.translate(CANVAS_SIZE/2, CANVAS_SIZE/2);
            ctx.rotate(-Math.PI/6);
            ctx.fillText("@nachozorra", 0, 0);
            ctx.restore();
        }

        /* DIBUJO PRINCIPAL */
        function draw() {
            const text = textInput.value.trim();
            const bgColor = bgColorInput.value;

            ctx.fillStyle = bgColor;
            ctx.fillRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);

            if (!text) return;

            if (mode === "normal") watermarkNormal();
            else watermarkBrat();

            /* CÃLCULOS SIN BLUR */
            ctx.filter = "none";

            const density = Math.log(1 + text.length);
            let fontSize = MAX_FONT_SIZE / (1 + density * (mode === "brat" ? 0.55 : 0.25));
            fontSize = Math.max(fontSize, MIN_FONT_SIZE);

            const font = mode === "brat" ? "var(--font-brat)" : "var(--font-normal)";
            const maxWidth = CANVAS_SIZE - PADDING * 2;

            ctx.font = `${fontSize}px ${font}`;

            const lines = wrapText(text, maxWidth, fontSize, font);
            const lineHeight = fontSize * 1.22;

            let y = (CANVAS_SIZE - lines.length * lineHeight) / 2;

            const textColor = isDarkColor(bgColor) ? "#fff" : "#111";

            /* AHORA SÃ ACTIVAMOS BLUR PARA DIBUJAR */
            if (mode === "brat") {
                ctx.filter = `blur(${density * 0.8}px)`;
            } else {
                ctx.filter = "none";
            }

            ctx.fillStyle = textColor;

            lines.forEach(line => {
                if (mode === "brat") {
                    drawJustified(line, CANVAS_SIZE/2, y, maxWidth, fontSize, font, textColor);
                } else {
                    /* Outline */
                    ctx.lineWidth = Math.max(4, fontSize*0.06);
                    ctx.strokeStyle = "rgba(0,0,0,0.35)";
                    ctx.strokeText(line, CANVAS_SIZE/2, y);
                    ctx.fillText(line, CANVAS_SIZE/2, y);
                }
                y += lineHeight;
            });
        }

        /* DESCARGAR */
        downloadBtn.addEventListener("click", () => {
            draw();
            const url = canvas.toDataURL("image/png");
            const a = document.createElement("a");
            a.href = url;
            a.download = "nachozorra_" + Date.now() + ".png";
            a.click();
        });

        /* SWITCH */
        modeToggle.addEventListener("click", ()=>{
            modeToggle.classList.toggle("active");
            mode = mode === "normal" ? "brat" : "normal";
            modeLabel.textContent = mode === "normal" ? "Normal" : "Brat";
            draw();
        });

        textInput.addEventListener("input", draw);
        bgColorInput.addEventListener("input", draw);

        window.onload = draw;
    </script>

</body>
</html>

