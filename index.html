<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>NachoZorra Generator ðŸ¦Š</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Felt Tip Roman -->
    <link href="https://fonts.cdnfonts.com/css/felt-tip-roman" rel="stylesheet">

    <style>
        :root {
            --felt-font: 'Felt Tip Roman', cursive;
        }

        body {
            font-family: var(--felt-font);
            margin: 0;
            padding: 0;
            background-color: #f3f4f6;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }

        .preview-container {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #previewCanvas {
            box-shadow: 0 10px 25px -3px rgba(0,0,0,0.25);
            border-radius: 1rem;
            max-width: 90vh;
            max-height: 90vw;
            aspect-ratio: 1 / 1;
            width: min(90vw, 90vh);
        }

        .control-panel {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid #e5e7eb;
            padding: 1rem;
            z-index: 10;
        }

        #bgColorInput {
            appearance: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 0 3px white, 0 0 0 4px #4b5563;
        }
    </style>
</head>
<body>

    <div class="preview-container">
        <canvas id="previewCanvas" width="1080" height="1080"></canvas>
    </div>

    <div class="control-panel flex flex-col md:flex-row items-center justify-center space-y-3 md:space-y-0 md:space-x-4">

        <div class="w-full md:w-3/5">
            <input type="text" id="textInput" placeholder="Escribe tu frase aquÃ­..."
                   value="NachoZorra Generator ðŸ¦Š"
                   class="w-full p-3 text-lg border-2 border-gray-300 rounded-xl focus:border-blue-600 
                          text-gray-700 shadow-inner placeholder-gray-400 focus:outline-none">
        </div>

        <div class="flex items-center space-x-4">
            <div class="flex items-center space-x-2">
                <label class="text-sm font-semibold text-gray-700">Fondo:</label>
                <input type="color" id="bgColorInput" value="#ffffff">
            </div>

            <button id="downloadBtn"
                    class="px-6 py-3 bg-indigo-600 text-white font-bold rounded-xl shadow-lg
                           hover:bg-indigo-700 active:bg-indigo-800 transition duration-150 transform hover:scale-105">
                Descargar PNG
            </button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById("previewCanvas");
        const ctx = canvas.getContext("2d");

        const textInput = document.getElementById("textInput");
        const bgColorInput = document.getElementById("bgColorInput");
        const downloadBtn = document.getElementById("downloadBtn");

        const CANVAS_SIZE = 1080;
        const PADDING = 100;

        const MAX_FONT_SIZE = 180;
        const MIN_FONT_SIZE = 60;
        const MAX_WORDS = 20;

        const FELT_FONT = "'Felt Tip Roman', cursive";

        /* UTILIDADES */

        function hexToRgb(hex) {
            const bigint = parseInt(hex.slice(1), 16);
            return [(bigint>>16)&255, (bigint>>8)&255, bigint&255];
        }

        function isDarkColor(hex) {
            const [r,g,b] = hexToRgb(hex);
            const luminance = (0.2126*r + 0.7152*g + 0.0722*b)/255;
            return luminance < 0.55;
        }

        /* Word wrap real */
        function wrapText(text, maxWidth, fontSize) {
            ctx.font = `${fontSize}px ${FELT_FONT}`;
            const words = text.split(" ");
            let line = "";
            const lines = [];

            for (let w of words) {
                const test = line + w + " ";
                if (ctx.measureText(test).width > maxWidth && line !== "") {
                    lines.push(line.trim());
                    line = w + " ";
                } else {
                    line = test;
                }
            }
            if (line.trim()) lines.push(line.trim());
            return lines;
        }

        /* Outline + fill para legibilidad mÃ¡xima */
        function drawTextWithOutline(line, x, y, fontSize, textColor) {
            ctx.lineWidth = Math.max(4, fontSize * 0.06);
            ctx.strokeStyle = "rgba(0,0,0,0.35)";
            ctx.strokeText(line, x, y);

            ctx.fillStyle = textColor;
            ctx.fillText(line, x, y);
        }

        /* MARCA DE AGUA diagonal detrÃ¡s del texto */
        function drawWatermark() {
            ctx.save();

            ctx.globalAlpha = 0.09; 
            ctx.fillStyle = "#000000"; 
            ctx.font = `240px ${FELT_FONT}`;
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";

            ctx.translate(CANVAS_SIZE/2, CANVAS_SIZE/2);
            ctx.rotate(-Math.PI / 6); // -30Â°

            ctx.fillText("@nachozorra", 0, 0);

            ctx.restore();
        }

        /* DIBUJO PRINCIPAL */

        function drawText() {
            const text = textInput.value.trim();
            const bgColor = bgColorInput.value;

            ctx.fillStyle = bgColor;
            ctx.fillRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);

            /* DIBUJAR MARCA DE AGUA */
            drawWatermark();

            if (!text) {
                ctx.fillStyle = "#777";
                ctx.font = `40px ${FELT_FONT}`;
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText("Escribe algo abajo...", CANVAS_SIZE/2, CANVAS_SIZE/2);
                return;
            }

            const words = text.split(/\s+/);
            const count = Math.min(words.length, MAX_WORDS);
            const ratio = count / MAX_WORDS;

            const fontSize = MAX_FONT_SIZE - ratio * (MAX_FONT_SIZE - MIN_FONT_SIZE);
            const opacity = 1 - ratio * 0.3;

            ctx.globalAlpha = opacity;
            ctx.textAlign = "center";
            ctx.textBaseline = "top";
            ctx.font = `${fontSize}px ${FELT_FONT}`;

            const textColor = isDarkColor(bgColor) ? "#ffffff" : "#111111";

            const maxWidth = CANVAS_SIZE - PADDING * 2;
            const lines = wrapText(text, maxWidth, fontSize);
            const lineHeight = fontSize * 1.2;

            const totalHeight = lines.length * lineHeight;
            let y = (CANVAS_SIZE - totalHeight) / 2;

            for (let line of lines) {
                drawTextWithOutline(line, CANVAS_SIZE/2, y, fontSize, textColor);
                y += lineHeight;
            }

            ctx.globalAlpha = 1;
        }

        /* DESCARGA */

        function downloadImage() {
            drawText();
            const url = canvas.toDataURL("image/png");
            const link = document.createElement("a");
            link.href = url;
            link.download = "nachozorra_" + Date.now() + ".png";
            link.click();
        }

        /* EVENTOS */

        textInput.addEventListener("input", drawText);
        bgColorInput.addEventListener("input", drawText);
        downloadBtn.addEventListener("click", downloadImage);

        window.onload = async () => {
            if (document.fonts && document.fonts.load) {
                await document.fonts.load(`60px ${FELT_FONT}`);
            }
            drawText();
        };
    </script>

</body>
</html>
